name: Publish Packages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  publish-ui:
    name: Publish @wolffm/trader (UI)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: https://npm.pkg.github.com
          scope: "@wolffm"
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.HADOKU_SITE_TOKEN }}

      - name: Build package
        run: pnpm run build

      - name: Check if UI package changed
        id: ui_changed
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(src/|package\.json)'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "✓ UI package has changes"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "✗ No changes in UI package"
          fi

      - name: Bump version if needed
        if: steps.ui_changed.outputs.changed == 'true'
        run: |
          package_name=$(node -p "require('./package.json').name")
          current_version=$(node -p "require('./package.json').version")

          echo "Current version: $current_version"

          # Check if version exists on GitHub Packages (use npm with explicit registry)
          if npm view "${package_name}@${current_version}" version --registry=https://npm.pkg.github.com 2>/dev/null; then
            echo "⚠️  Version $current_version already published, bumping..."

            major=$(echo $current_version | cut -d. -f1)
            minor=$(echo $current_version | cut -d. -f2)
            patch=$(echo $current_version | cut -d. -f3)

            if [ $patch -eq 20 ]; then
              new_version="$major.$((minor + 1)).0"
            else
              new_version="$major.$minor.$((patch + 1))"
            fi

            node -e "const fs = require('fs'); const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8')); pkg.version = process.argv[1]; fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');" "$new_version"
            echo "✅ Version bumped: $current_version → $new_version"
            pnpm install --lockfile-only
          else
            echo "✓ Version $current_version not yet published, proceeding"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.HADOKU_SITE_TOKEN }}

      - name: Publish UI package
        if: steps.ui_changed.outputs.changed == 'true'
        run: pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.HADOKU_SITE_TOKEN }}

    outputs:
      published: ${{ steps.ui_changed.outputs.changed }}

  publish-worker:
    name: Publish @wolffm/trader-worker (API)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: https://npm.pkg.github.com
          scope: "@wolffm"
          cache: pnpm
          cache-dependency-path: worker/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: worker
        run: pnpm install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.HADOKU_SITE_TOKEN }}

      - name: Build package
        working-directory: worker
        run: pnpm run build

      - name: Check if worker package changed
        id: worker_changed
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE '^worker/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "✓ Worker package has changes"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "✗ No changes in worker package"
          fi

      - name: Bump version if needed
        if: steps.worker_changed.outputs.changed == 'true'
        working-directory: worker
        run: |
          package_name=$(node -p "require('./package.json').name")
          current_version=$(node -p "require('./package.json').version")

          echo "Current version: $current_version"

          # Check if version exists on GitHub Packages (use npm with explicit registry)
          if npm view "${package_name}@${current_version}" version --registry=https://npm.pkg.github.com 2>/dev/null; then
            echo "⚠️  Version $current_version already published, bumping..."

            major=$(echo $current_version | cut -d. -f1)
            minor=$(echo $current_version | cut -d. -f2)
            patch=$(echo $current_version | cut -d. -f3)

            if [ $patch -eq 20 ]; then
              new_version="$major.$((minor + 1)).0"
            else
              new_version="$major.$minor.$((patch + 1))"
            fi

            node -e "const fs = require('fs'); const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8')); pkg.version = process.argv[1]; fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');" "$new_version"
            echo "✅ Version bumped: $current_version → $new_version"
            pnpm install --lockfile-only
          else
            echo "✓ Version $current_version not yet published, proceeding"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.HADOKU_SITE_TOKEN }}

      - name: Publish worker package
        if: steps.worker_changed.outputs.changed == 'true'
        working-directory: worker
        run: pnpm publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.HADOKU_SITE_TOKEN }}

    outputs:
      published: ${{ steps.worker_changed.outputs.changed }}

  publish-python:
    name: Publish hadoku-fidelity (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check if Python package changed
        id: python_changed
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -qE '^(fidelity-api/|trader-worker/)'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "✓ Python package has changes"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "✗ No changes in Python package"
          fi

      - name: Install build tools
        if: steps.python_changed.outputs.changed == 'true'
        run: pip install build twine

      - name: Build Python package
        if: steps.python_changed.outputs.changed == 'true'
        working-directory: fidelity-api
        run: python -m build

      - name: Publish to PyPI
        if: steps.python_changed.outputs.changed == 'true'
        working-directory: fidelity-api
        run: twine upload dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

    outputs:
      published: ${{ steps.python_changed.outputs.changed }}

  notify-hadoku-site:
    name: Notify hadoku-site
    needs: [publish-ui, publish-worker, publish-python]
    if: needs.publish-ui.outputs.published == 'true' || needs.publish-worker.outputs.published == 'true' || needs.publish-python.outputs.published == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger hadoku-site rebuild
        env:
          HADOKU_SITE_TOKEN: ${{ secrets.HADOKU_SITE_TOKEN }}
        run: |
          packages=""
          if [ "${{ needs.publish-ui.outputs.published }}" == "true" ]; then
            packages="$packages @wolffm/trader"
          fi
          if [ "${{ needs.publish-worker.outputs.published }}" == "true" ]; then
            packages="$packages @wolffm/trader-worker"
          fi
          if [ "${{ needs.publish-python.outputs.published }}" == "true" ]; then
            packages="$packages hadoku-fidelity"
          fi

          echo "Notifying hadoku-site about:$packages"

          curl -sS -X POST "https://api.github.com/repos/WolffM/hadoku_site/dispatches" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $HADOKU_SITE_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d "{\"event_type\": \"packages_updated\", \"client_payload\": {\"packages\": \"$packages\", \"sha\": \"${{ github.sha }}\"}}"

          echo "✅ Notified hadoku-site"
